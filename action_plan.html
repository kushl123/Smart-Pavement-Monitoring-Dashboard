<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Pavement Monitoring Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300,400,500,700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f7f6;
            color: #34495e;
            line-height: 1.6;
        }

        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background-color: white;
            color: #2c3e50;
            padding: 25px 40px;
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .header p {
            opacity: 0.8;
            font-size: 0.9em;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #007bff;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            color: #7f8c8d;
            font-size: 0.8em;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 400;
        }

        .card .value {
            font-size: 2.0em;
            font-weight: 700;
            color: #2c3e50;
        }

        .card .sub-value {
            color: #95a5a6;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .content-grid {
            /* Main content: E.g., Major Chart (2 parts) and Side List (1 part) */
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        /* NEW: Grid for the two bottom charts (Maintenance Costs and Budget Utilization) */
        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .chart-card,
        .list-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: 0;
        }

        .chart-card h2,
        .list-card h2 {
            margin-bottom: 20px;
            color: #34495e;
            font-size: 1.2em;
            font-weight: 500;
            border-bottom: 1px solid #f4f7f6;
            padding-bottom: 10px;
        }

        /* Chart Containers - Set to a common height for alignment */
        #monthlyChartContainer,
        #quarterlyCostChartContainer,
        #yearlyBudgetUtilizationChartContainer {
            position: relative;
            height: 250px;
            width: 100%;
        }


        .department-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed #ecf0f1;
            font-size: 0.9em;
        }

        .department-item:last-child {
            border-bottom: none;
        }

        .dept-name {
            font-weight: 500;
        }

        .dept-metric {
            font-weight: 700;
            color: #2980b9;
        }

        .dept-metric.low {
            color: #e74c3c;
        }

        .dept-metric.high {
            color: #2ecc71;
        }

        .bottom-grid {
            /* This is where the Gantt and Incidents list are placed. */
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 20px;
        }

        /* ... (rest of the specific styles: incident-header, gantt-labels, etc.) ... */
        /* The Gantt chart list content itself is not canvas-based, so it will not overlay the chart. */
        .incidents-list-container {
            overflow-x: auto;
        }

        .incident-header,
        .incident-item-row {
            display: grid;
            grid-template-columns: 100px 1.5fr 1fr 100px 80px;
            gap: 15px;
            padding: 12px 0;
            align-items: center;
        }

        .incident-header {
            font-weight: 700;
            color: #7f8c8d;
            text-transform: uppercase;
            font-size: 0.75em;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #ecf0f1;
            margin-bottom: 5px;
        }

        .incident-item-row {
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.9em;
        }

        .severity-high,
        .severity-medium,
        .severity-critical {
            font-weight: 500;
        }

        .severity-high {
            color: #e74c3c;
        }

        .severity-medium {
            color: #f39c12;
        }

        .severity-critical {
            color: #c0392b;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 700;
            text-align: center;
        }

        .status-assigned {
            background: #ffeeba;
            color: #856404;
        }

        .status-in-progress {
            background: #cce5ff;
            color: #004085;
        }

        .status-resolved {
            background: #d4edda;
            color: #155724;
        }

        .status-planned {
            background: #f8d7da;
            color: #721c24;
        }

        .gantt-chart-container {
            padding-top: 15px;
            font-size: 0.9em;
        }

        .gantt-labels {
            display: grid;
            grid-template-columns: 150px 1fr;
            font-weight: 500;
            padding-bottom: 10px;
            border-bottom: 1px solid #ecf0f1;
            color: #7f8c8d;
        }

        .gantt-labels>div:nth-child(2) {
            display: flex;
            justify-content: space-around;
        }

        .gantt-task-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f4f7f6;
        }

        .gantt-task-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .gantt-bar-area {
            position: relative;
            height: 18px;
            margin-left: 10px;
            margin-right: 10px;
        }

        .gantt-bar {
            position: absolute;
            height: 100%;
            border-radius: 3px;
            color: white;
            font-size: 0.7em;
            line-height: 18px;
            padding: 0 5px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            font-weight: 500;
        }

        .gantt-bar.completed {
            background-color: #2ecc71;
        }

        .gantt-bar.in_progress {
            background-color: #3498db;
        }

        .gantt-bar.planned {
            background-color: #f39c12;
            opacity: 0.6;
        }

        @media (max-width: 1200px) {
            .content-grid {
                grid-template-columns: 1fr;
            }

            .bottom-grid {
                grid-template-columns: 1fr;
            }

            /* NEW: Stack the budget charts vertically on small screens */
            .charts-row {
                grid-template-columns: 1fr;
            }

            #monthlyChartContainer,
            #quarterlyCostChartContainer,
            #yearlyBudgetUtilizationChartContainer {
                height: 400px;
            }
        }
        .navigation-cards {
        display: flex;
        gap: 20px;
        padding: 0 0 25px 0;
        flex-wrap: wrap;
    }
    
    .nav-card {
        display: flex;
        align-items: center;
        background: white;
        border-radius: 8px;
        padding: 16px 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        flex: 1;
        min-width: 300px;
        text-decoration: none;
        color: #34495e;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid #ecf0f1;
    }
    
    .nav-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .nav-card-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 48px;
        height: 48px;
        background-color: rgba(52, 152, 219, 0.1);
        border-radius: 12px;
        margin-right: 16px;
        color: #3498db;
    }
    
    .nav-card-content {
        flex-grow: 1;
    }
    
    .nav-card-content h3 {
        font-size: 16px;
        margin-bottom: 5px;
    }
    
    .nav-card-content p {
        font-size: 13px;
        color: #7f8c8d;
        margin: 0;
    }
    
    .nav-card-arrow {
        font-size: 24px;
        font-weight: 300;
        color: #7f8c8d;
        margin-left: 10px;
    }
    </style>
</head>

<body>
    <div class="dashboard">
        <div class="header">
            <h1>Action Plan: City assets, maintenance, and incident management</h1>
            <div class="navigation-cards">
                <a href="mainpage.html" class="nav-card">
                    <div class="nav-card-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                    </div>
                    <div class="nav-card-content">
                        <h3>Executive Dashboard</h3>
                        <p>Return to main dashboard with monitoring analytics</p>
                    </div>
                    <div class="nav-card-arrow">→</div>
                </a>
                
                <a href="department.html" class="nav-card">
                    <div class="nav-card-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                            <line x1="8" y1="21" x2="16" y2="21"></line>
                            <line x1="12" y1="17" x2="12" y2="21"></line>
                        </svg>
                    </div>
                    <div class="nav-card-content">
                        <h3>Department Dashboards</h3>
                        <p>Access specialized dashboards for Works, Traffic & Waste Management</p>
                    </div>
                    <div class="nav-card-arrow">→</div>
                </a>
            </div>
        </div>

        <div class="summary-cards" id="summaryCards">
        </div>

        <div class="content-grid">
            <div class="chart-card">
                <h2>Monthly Progress Trend (Issues vs. Resolutions)</h2>
                <div id="monthlyChartContainer">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
            <div class="list-card">
                <h2>Department Efficiency Ranking (Score)</h2>
                <div id="departmentPerformanceList">
                </div>
            </div>
        </div>
        
        <div class="charts-row">
            <div class="chart-card">
                <h2>Quarterly Infrastructure Maintenance Costs vs. Target</h2>
                <div id="quarterlyCostChartContainer">
                    <canvas id="quarterlyCostChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h2>Yearly Budget Utilization Rate vs. Target</h2>
                <div id="yearlyBudgetUtilizationChartContainer">
                    <canvas id="yearlyBudgetUtilizationChart"></canvas>
                </div>
            </div>
        </div>

        <div class="bottom-grid">
            <div class="list-card">
                <h2>Project Gantt View (Task Duration)</h2>
                <div class="gantt-chart-container" id="ganttChartContainer">
                </div>
            </div>
            <div class="list-card">
                <h2>Recent Critical & High Incidents</h2>
                <div class="incidents-list-container">
                    <div class="incident-header">
                        <div>ID</div>
                        <div>Type / Location</div>
                        <div>Assigned To</div>
                        <div>Status</div>
                        <div>Days Open</div>
                    </div>
                    <div id="incidentsList">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // UPDATED: Added quarterlyCosts and yearlyBudgetUtilization
        let summaryData, monthlyMetrics, departmentPerformance, recentIncidents, timelineData, quarterlyCosts, yearlyBudgetUtilization;

        function daysBetween(date1, date2) {
            const diffTime = Math.abs(date2.getTime() - date1.getTime());
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function formatCurrency(amount) {
            return `₹${(amount / 1000000).toFixed(1)} Cr`;
        }

        async function loadData() {
            // UPDATED: Added quarterly_costs and yearly_budget_utilization
            const filePaths = {
                summary: 'data/dashboard_summary.json',
                metrics: 'data/monthly_metrics.json',
                dept: 'data/department_performance.json',
                incidents: 'data/recent_incidents.json',
                timeline: 'data/timeline_data.json',
                quarterly_costs: 'data/quarterly_costs.json',
                yearly_budget_utilization: 'data/yearly_budget_utilization.json' // NEW DATA PATH
            };

            const dataPromises = Object.keys(filePaths).map(key =>
                fetch(filePaths[key]).then(res => {
                    if (!res.ok) throw new Error(`Failed to load ${filePaths[key]} from data/ folder. Please ensure files are in 'data/' sub-directory.`);
                    return res.json();
                })
            );

            // UPDATED: Added yearlyBudgetUtilization to destructuring
            [summaryData, monthlyMetrics, departmentPerformance, recentIncidents, timelineData, quarterlyCosts, yearlyBudgetUtilization] = await Promise.all(dataPromises);

            initDashboard();
        }

        function renderSummaryCards() {
            const container = document.getElementById('summaryCards');
            container.innerHTML = '';

            const totalDetections = monthlyMetrics.reduce((acc, m) => acc + m.new_detections, 0);
            const totalCriticalResolved = monthlyMetrics.reduce((acc, m) => acc + m.critical_resolved, 0);

            const cards = [
                {
                    title: "Total Issues Detected",
                    value: summaryData.total_issues_detected,
                    subValue: `+${totalDetections} detections this cycle`
                },
                {
                    title: "Resolution Rate",
                    value: `${summaryData.resolution_rate}%`,
                    subValue: `${summaryData.resolved_issues} issues resolved`
                },
                {
                    title: "Avg. Resolution Time",
                    value: `${summaryData.avg_resolution_time_days} days`,
                    subValue: `Target: < 10 days (Risk)`
                },
                {
                    title: "Critical Issues Open",
                    value: summaryData.critical_issues_open,
                    subValue: `Total critical resolved: ${totalCriticalResolved}`
                },
                {
                    title: "Current Backlog",
                    value: monthlyMetrics[monthlyMetrics.length - 1].backlog,
                    subValue: `Across ${summaryData.departments_involved} departments`
                }
            ];

            cards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card';
                cardElement.innerHTML = `
                    <h3>${card.title}</h3>
                    <div class="value">${card.value}</div>
                    <div class="sub-value">${card.subValue}</div>
                `;
                container.appendChild(cardElement);
            });
        }

        function renderMonthlyChart() {
            const labels = monthlyMetrics.map(m => m.month.split(' ')[0]);
            const newDetections = monthlyMetrics.map(m => m.new_detections);
            const resolutions = monthlyMetrics.map(m => m.resolutions);

            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'New Detections',
                            data: newDetections,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Resolutions',
                            data: resolutions,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Roboto'
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count',
                                font: {
                                    family: 'Roboto',
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: '#ecf0f1'
                            }
                        }
                    }
                }
            });
        }

        function renderQuarterlyCostChart() {
            if (!quarterlyCosts) return;

            const labels = quarterlyCosts.map(d => d.quarter);
            const maintenanceCosts = quarterlyCosts.map(d => d.maintenance_costs);
            const target = quarterlyCosts.map(d => d.target);

            const ctx = document.getElementById('quarterlyCostChart').getContext('2d');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'Infrastructure Maintenance Costs',
                            data: maintenanceCosts,
                            backgroundColor: '#3498db', // Blue for Costs
                            borderColor: '#3498db',
                            borderWidth: 1,
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            type: 'line',
                            label: 'Target Cost',
                            data: target,
                            borderColor: '#e74c3c', // Red for Target
                            backgroundColor: 'rgba(231, 76, 60, 0.5)',
                            pointRadius: 6,
                            pointBackgroundColor: '#c0392b',
                            fill: false,
                            tension: 0.2,
                            yAxisID: 'y',
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Roboto'
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        // Format as INR in Millions
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cost (INR)',
                                font: {
                                    family: 'Roboto',
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                // Format y-axis ticks as INR in Millions
                                callback: function(value, index, values) {
                                    return formatCurrency(value);
                                }
                            },
                            grid: {
                                color: '#ecf0f1'
                            }
                        }
                    }
                }
            });
        }

        // NEW FUNCTION: Renders the Yearly Budget Utilization Bar/Line Chart
        function renderYearlyBudgetUtilizationChart() {
            if (!yearlyBudgetUtilization) return;

            const labels = yearlyBudgetUtilization.map(d => d.year);
            const utilizationRate = yearlyBudgetUtilization.map(d => d.utilization_rate);
            const target = yearlyBudgetUtilization.map(d => d.target);

            // Calculate average for the line graph
            const averageUtilization = utilizationRate.reduce((a, b) => a + b, 0) / utilizationRate.length;
            const averageData = new Array(labels.length).fill(averageUtilization);


            const ctx = document.getElementById('yearlyBudgetUtilizationChart').getContext('2d');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'Budget Utilization Rate',
                            data: utilizationRate,
                            backgroundColor: '#2ecc71', // Green for utilization
                            borderColor: '#2ecc71',
                            borderWidth: 1,
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            type: 'line',
                            label: 'Target',
                            data: target,
                            borderColor: '#34495e', // Dark for Target
                            pointRadius: 6,
                            pointBackgroundColor: '#34495e',
                            fill: false,
                            tension: 0.2,
                            yAxisID: 'y',
                            order: 1
                        },
                        {
                            type: 'line',
                            label: `Average: ${averageUtilization.toFixed(1)}%`,
                            data: averageData,
                            borderColor: '#f39c12', // Orange for Average
                            borderDash: [5, 5],
                            pointRadius: 0,
                            borderWidth: 2,
                            fill: false,
                            tension: 0,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Roboto'
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                // Format tooltip values as percentages
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += `${context.parsed.y.toFixed(1)}%`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100, // Max set to 100% for utilization
                            title: {
                                display: true,
                                text: 'Utilization Rate (%)',
                                font: {
                                    family: 'Roboto',
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                // Format y-axis ticks as percentages
                                callback: function(value, index, values) {
                                    return `${value}%`;
                                }
                            },
                            grid: {
                                color: '#ecf0f1'
                            }
                        }
                    }
                }
            });
        }

        function renderDepartmentPerformance() {
            const container = document.getElementById('departmentPerformanceList');
            container.innerHTML = '';

            const sortedData = [...departmentPerformance].sort((a, b) => b.efficiency_score - a.efficiency_score);

            sortedData.forEach(item => {
                const isLow = item.efficiency_score < 7.0;
                const scoreClass = isLow ? 'low' : 'high';

                const itemElement = document.createElement('div');
                itemElement.className = 'department-item';
                itemElement.innerHTML = `
                    <span class="dept-name">${item.department}</span>
                    <span class="dept-metric ${scoreClass}">${item.efficiency_score.toFixed(1)}</span>
                `;
                container.appendChild(itemElement);
            });
        }

        function renderGanttChart() {
            const container = document.getElementById('ganttChartContainer');
            container.innerHTML = '';

            // This calculation logic is for a simplified, static-month Gantt-like view.
            const allDates = timelineData.flatMap(t => [new Date(t.start_date), new Date(t.end_date)]);
            const minDate = new Date(Math.min(...allDates));
            const maxDate = new Date(Math.max(...allDates));
            const totalDays = daysBetween(minDate, maxDate);

            // Generate monthly labels based on the data range for the Gantt header
            const startMonth = minDate.getMonth();
            const endMonth = maxDate.getMonth();
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            let dateLabels = [];
            for (let i = startMonth; i <= endMonth; i++) {
                dateLabels.push(months[i % 12]);
            }

            const labelRow = document.createElement('div');
            labelRow.className = 'gantt-labels';
            labelRow.innerHTML = `<div>Task Name</div><div>${dateLabels.map(label => `<span>${label}</span>`).join('')}</div>`;
            container.appendChild(labelRow);

            // Adjusting CSS for month labels
            const ganttLabelsDiv = labelRow.querySelector('.gantt-labels > div:nth-child(2)');
            if (ganttLabelsDiv) {
                ganttLabelsDiv.style.gridTemplateColumns = `repeat(${dateLabels.length}, 1fr)`;
                ganttLabelsDiv.style.display = 'grid';
                ganttLabelsDiv.style.textAlign = 'center';
            }

            // Adjust CSS for the bar area to match grid
            const style = document.createElement('style');
            style.innerHTML = `
                .gantt-labels > div:nth-child(2) > * {
                    flex-grow: 1;
                    text-align: center;
                }
            `;
            document.head.appendChild(style);


            timelineData.forEach(item => {
                const startDate = new Date(item.start_date);
                const endDate = new Date(item.end_date);

                // Calculate position based on the total day range
                const startOffsetDays = daysBetween(minDate, startDate);
                const taskDurationDays = daysBetween(startDate, endDate);

                // Calculate percentages for CSS
                const left = (startOffsetDays / totalDays) * 100;
                const width = (taskDurationDays / totalDays) * 100;
                const statusClass = item.status.replace('_', '-').toLowerCase();

                const rowElement = document.createElement('div');
                rowElement.className = 'gantt-task-row';
                rowElement.innerHTML = `
                    <div class="gantt-task-name">${item.task_name}</div>
                    <div class="gantt-bar-area">
                        <div class="gantt-bar ${statusClass}" style="left: ${left}%; width: ${width}%;">
                            ${width > 15 ? `${item.completion_percentage}%` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(rowElement);
            });
        }

        function renderIncidents() {
            const container = document.getElementById('incidentsList');
            container.innerHTML = '';

            const filteredData = recentIncidents
                .filter(i => i.severity === 'High' || i.severity === 'Critical' || i.days_open > 0)
                .sort((a, b) => b.days_open - a.days_open);

            filteredData.forEach(incident => {
                const statusClass = incident.status.replace(' ', '-').toLowerCase();
                const severityClass = incident.severity.toLowerCase();

                const itemElement = document.createElement('div');
                itemElement.className = 'incident-item-row';
                itemElement.innerHTML = `
                    <div>${incident.id.split('-')[2]}</div>
                    <div class="severity-${severityClass}">${incident.type}<br><span class="timeline-meta">${incident.location}</span></div>
                    <div>${incident.assigned_to}</div>
                    <div class="status-badge status-${statusClass}">${incident.status}</div>
                    <div class="severity-${severityClass}">${incident.days_open}</div>
                `;
                container.appendChild(itemElement);
            });
        }

        function initDashboard() {
            renderSummaryCards();
            renderMonthlyChart();
            renderQuarterlyCostChart();
            renderYearlyBudgetUtilizationChart(); // NEW CHART CALLED HERE
            renderDepartmentPerformance();
            renderGanttChart();
            renderIncidents();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadData().catch(error => {
                const errorElement = document.createElement('div');
                errorElement.style.color = '#c0392b';
                errorElement.style.padding = '20px';
                errorElement.style.backgroundColor = '#fbecec';
                errorElement.style.border = '1px solid #c0392b';
                errorElement.style.borderRadius = '8px';
                errorElement.style.margin = '20px auto';
                errorElement.style.maxWidth = '600px';
                errorElement.innerHTML = `<h2>Data Loading Error</h2><p>Could not load data. Please ensure your files are accessible at the paths: <code>${error.message}</code></p>`;
                document.body.prepend(errorElement);
            });
        });
    </script>
</body>

</html>